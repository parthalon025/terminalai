name: Validate CI/CD Setup

# Workflow to validate CI/CD configuration files
# Runs on workflow file changes to catch configuration errors early

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - '.pre-commit-config.yaml'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'Makefile'
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  validate-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate workflow YAML
        run: |
          yamllint .github/workflows/*.yml \
            -d "{extends: default, rules: {line-length: {max: 120}, truthy: disable}}"

      - name: Validate docker-compose
        run: |
          yamllint docker-compose.yml \
            -d "{extends: default, rules: {line-length: {max: 120}}}"

      - name: Validate pre-commit config
        run: |
          yamllint .pre-commit-config.yaml \
            -d "{extends: default, rules: {line-length: {max: 120}}}"

  validate-docker:
    name: Validate Docker Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3013

      - name: Validate docker-compose
        run: |
          docker-compose config --quiet

  validate-makefile:
    name: Validate Makefile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install make
        run: sudo apt-get update && sudo apt-get install -y make

      - name: Validate Makefile syntax
        run: make -n help

      - name: Test help command
        run: make help

  validate-pre-commit:
    name: Validate Pre-commit Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Validate pre-commit config
        run: pre-commit validate-config

      - name: Validate pre-commit manifest
        run: pre-commit validate-manifest

  validate-pyproject:
    name: Validate pyproject.toml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install validation tools
        run: pip install validate-pyproject[all]

      - name: Validate pyproject.toml
        run: validate-pyproject pyproject.toml

      - name: Check package metadata
        run: |
          pip install build
          python -m build --sdist --wheel
          python -c "
          import configparser
          from pathlib import Path
          import tarfile

          # Extract metadata from sdist
          sdist = list(Path('dist').glob('*.tar.gz'))[0]
          with tarfile.open(sdist) as tar:
              pkg_info = tar.extractfile([m for m in tar.getmembers() if 'PKG-INFO' in m.name][0])
              content = pkg_info.read().decode('utf-8')
              print('Package metadata valid')
              print(content[:500])
          "

  security-scan-configs:
    name: Security Scan Configuration Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Scan for secrets in configs
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  test-ci-locally:
    name: Test CI Commands Locally
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Test lint commands
        run: |
          ruff --version
          black --version

      - name: Test make targets
        run: |
          make help
          make clean

  validate-documentation:
    name: Validate Documentation Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
          folder-path: 'docs/'
          file-extension: '.md'

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs:
      - validate-yaml
      - validate-docker
      - validate-makefile
      - validate-pre-commit
      - validate-pyproject
      - security-scan-configs
      - test-ci-locally
    if: always()
    steps:
      - name: Check all validations passed
        run: |
          echo "YAML Validation: ${{ needs.validate-yaml.result }}"
          echo "Docker Validation: ${{ needs.validate-docker.result }}"
          echo "Makefile Validation: ${{ needs.validate-makefile.result }}"
          echo "Pre-commit Validation: ${{ needs.validate-pre-commit.result }}"
          echo "Pyproject Validation: ${{ needs.validate-pyproject.result }}"
          echo "Security Scan: ${{ needs.security-scan-configs.result }}"
          echo "CI Commands Test: ${{ needs.test-ci-locally.result }}"

          if [ "${{ needs.validate-yaml.result }}" != "success" ] || \
             [ "${{ needs.validate-docker.result }}" != "success" ] || \
             [ "${{ needs.validate-makefile.result }}" != "success" ] || \
             [ "${{ needs.validate-pre-commit.result }}" != "success" ] || \
             [ "${{ needs.validate-pyproject.result }}" != "success" ]; then
            echo "::error::One or more validations failed"
            exit 1
          fi

          echo "âœ“ All CI/CD configuration validations passed!"
